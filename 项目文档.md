# Ai Push Voice Clone 2.0 项目文档

## 项目简介
- **目标**：基于哔哩哔哩 IndexTTS2 模型，提供网页端声音克隆服务。
- **技术栈**：Gradio 5.x（前端 UI + 后端接口），FastAPI 宿主应用，Python 3.10+。
- **服务模式**：通过硅基流动 API 调用 IndexTeam/IndexTTS-2 模型，支持文本克隆、情感控制、生成音色 URI。

## 功能结构
### Web 前端（Gradio Blocks）
- **登录壳**：通过激活码登录，完成额度与有效期校验。
- **声音克隆面板**：
  - 上传参考音频、填写文本、调节语速/音调/音量。
  - 四种情感模式（复用音色、情感音频、情感向量、情感描述）。
  - 高级参数默认隐藏，采样默认关闭。
  - 克隆结果自动播放，并显示情感模式与 `speech:` URI。

### 管理后台（独立子应用）
- **激活码登录**：默认口令 `admin123`（可通过 `ADMIN_PASSWORD` 环境变量覆盖）。
- **激活码管理**：
  - 生成激活码：设置音色额度、字符额度、有效期与备注。
  - 激活码列表：查看、刷新、更新额度、启用/禁用。
  - 所有按钮 `queue=False`，操作即时反馈。

## 关键修复与设计
1. **后台 404 与静态资源问题**：Gradio 5.x 的多路径挂载在 FastAPI 中默认路由会冲突。处理方式：
   - 使用独立 `FastAPI(root_path="/azttsdamin")` 子应用挂载后台 Blocks。
   - 主应用先挂载后台子应用，再挂载前台 Blocks。
2. **登录与操作卡顿**：Gradio 默认走队列，按钮事件需两次握手。处理方式：
   - 所有后台按钮设置 `queue=False`，包括登录、生成、刷新、更新、启用/禁用。
3. **采样默认关闭**：将高级参数预设、UI 初始值中的 `do_sample` 改为 `False`。
4. **Manifest 404**：为主应用注册 `/manifest.json` 与 `/azttsdamin/manifest.json` 路由，返回简易 PWA 配置。
5. **状态输出优化**：克隆结果状态仅展示“成功/失败”与情感模式。

## 目录结构
```
├─app.py                 # 主程序（Gradio + FastAPI 集成）
├─activation_manager.py  # 激活码存储、校验、额度更新
├─config.py              # 配置加载（API Key、端口、默认参数）
├─activation_codes.json  # 激活码存储文件
├─siliconflowkey.env     # 环境变量配置（API_KEY、ADMIN_PASSWORD 等）
├─README.md / quick_start.txt 等
└─测试/                  # 截图、样例音频、分析文档
```

## 部署与运行
1. **环境准备**：
   ```bash
   pip install -r requirements.txt
   ```
2. **配置 API Key**：编辑 `siliconflowkey.env` 写入 `API_KEY=...`，如需自定义后台口令，添加 `ADMIN_PASSWORD=...`。
3. **启动服务**：
   ```bash
   python app.py
   ```
4. **访问入口**：
   - 前台：`http://127.0.0.1:7860/`
   - 后台：`http://127.0.0.1:7860/azttsdamin/`

## 运维与开发注意事项
- **前台登录激活码**：
  - 校验额度、有效期、状态；支持复用最近生成的 `speech:` URI。
  - 建议长文本拆分合成，避免语速不均。
- **后台激活码管理**：
  - 操作直接作用于 `activation_codes.json`；在多实例部署时，需考虑共享存储。
  - 高并发情景下可扩展数据库或云存储。
- **API 调用限制**：
  - 确认硅基流动接口的文本长度限制，必要时在前端提示用户分段输入。
- **日志与监控**：
  - 默认打印 Gradio `new /` 路由提示，可按需接入 FastAPI 日志或监控方案。
- **升级注意**：
  - Gradio 5.x 多路径挂载需使用子应用方式；后续升级时请关注路线图。
  - 环境依赖变更后执行 `pip install -r requirements.txt --force-reinstall`。

## 日常使用建议（供用户）
- 上传清晰、无底噪的参考音频（5–20 秒）。
- 长文本可分段输入，或在句子间添加标点增强停顿效果。
- 生成成功后可复制 `speech:` URI 在后续合成中复用。
- 不同情感模式可搭配情感音频或向量细调语气。

## 常见问题
- **Invalid voice**：确认 `speech:` URI 或激活码额度有效。
- **剩余字符不足**：减少输入文本或更新激活码额度。
- **采样差异大**：保持采样关闭或仅在需求明确时开启，与语速调整配合。
- **404/静态资源缺失**：确保使用子应用挂载方式，清空浏览器缓存后重试。

---
如需进一步开发（批量合成、文本自动拆分、SSML 支持），建议在服务端增加预处理脚本或参考硅基流动的高级接口功能。
